---
import BaseLayout from "./BaseLayout.astro";
import Hr from "@/components/Hr.astro";
import ScrollProgress from "@/components/ScrollProgress.astro";
import ShareLinks from "@/components/ShareLinks.astro";
import NewsletterForm from "@/components/NewsletterForm.astro";
import PrevNextNav from "@/components/PrevNextNav.astro";
import { formatDate, getReadingTime } from "@/utils/posts";
import { slugifyTag } from "@/utils/slugifyTag";
import { SITE, GITHUB_REPO } from "@/utils/config";

interface Props {
  title: string;
  description: string;
  pubDatetime: Date;
  modDatetime?: Date;
  tags?: string[];
  body: string;
  ogImage?: string;
  slug: string;
  prevPost?: { title: string; slug: string } | null;
  nextPost?: { title: string; slug: string } | null;
}

const {
  title,
  description,
  pubDatetime,
  modDatetime,
  tags = [],
  body,
  ogImage,
  slug,
  prevPost,
  nextPost,
} = Astro.props;

const readTime = getReadingTime(body);
const postUrl = `${SITE.url}/posts/${slug}/`;
const editUrl = `${GITHUB_REPO}/edit/main/src/content/blog/${slug}.mdx`;

const ogImageFull = ogImage
  ? ogImage.startsWith("http")
    ? ogImage
    : `${SITE.url}${ogImage}`
  : `${SITE.url}${SITE.ogImage}`;

const blogPostingSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  headline: title,
  description: description,
  image: ogImageFull,
  datePublished: pubDatetime.toISOString(),
  dateModified: modDatetime ? modDatetime.toISOString() : pubDatetime.toISOString(),
  author: {
    "@type": "Person",
    name: SITE.author,
    url: SITE.url,
  },
  publisher: {
    "@type": "Person",
    name: SITE.author,
    url: SITE.url,
  },
  mainEntityOfPage: {
    "@type": "WebPage",
    "@id": postUrl,
  },
  wordCount: body.trim().split(/\s+/).length,
  keywords: tags.join(", "),
};

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  itemListElement: [
    { "@type": "ListItem", position: 1, name: "Home", item: SITE.url },
    { "@type": "ListItem", position: 2, name: "Posts", item: `${SITE.url}/posts/` },
    { "@type": "ListItem", position: 3, name: title, item: postUrl },
  ],
};
---

<BaseLayout
  title={title}
  description={description}
  ogImage={ogImage}
  ogType="article"
  publishedTime={pubDatetime.toISOString()}
  modifiedTime={modDatetime ? modDatetime.toISOString() : undefined}
  articleAuthor={SITE.author}
  articleTags={tags}
>
  <ScrollProgress />

  <main id="main-content" class="mx-auto w-full max-w-3xl px-4 pb-12">
    <!-- JSON-LD Structured Data -->
    <script type="application/ld+json" set:html={JSON.stringify(blogPostingSchema)} />
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />

    <!-- Go back link -->
    <div class="mt-8 mb-8">
      <a
        href="/posts"
        class="group flex items-center gap-1 hover:text-foreground/75"
      >
        <svg
          class="inline-block size-6 transition-transform group-hover:-translate-x-1"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M15 19l-7-7 7-7"></path>
        </svg>
        <span>Go back</span>
      </a>
    </div>

    <!-- Post title -->
    <h1
      class="inline-block text-2xl font-bold text-accent sm:text-3xl"
      style={`view-transition-name: ${title.toLowerCase().replace(/\s+/g, "-").replace(/[^a-z0-9-]/g, "")}`}
    >
      {title}
    </h1>

    <!-- Date, reading time, edit link -->
    <div class="mt-2 mb-3 flex flex-wrap items-center gap-x-3 gap-y-1">
      <div class="flex items-center gap-2 opacity-80">
        <svg
          class="inline-block size-5 min-w-[1.25rem]"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
          <line x1="16" y1="2" x2="16" y2="6"></line>
          <line x1="8" y1="2" x2="8" y2="6"></line>
          <line x1="3" y1="10" x2="21" y2="10"></line>
        </svg>
        {
          modDatetime && modDatetime > pubDatetime ? (
            <span class="text-sm italic">Updated:</span>
          ) : (
            <span class="sr-only">Published:</span>
          )
        }
        <span class="text-sm italic">
          <time
            datetime={(modDatetime && modDatetime > pubDatetime
              ? modDatetime
              : pubDatetime
            ).toISOString()}
          >
            {formatDate(
              modDatetime && modDatetime > pubDatetime
                ? modDatetime
                : pubDatetime
            )}
          </time>
        </span>
      </div>
      <span class="text-sm italic opacity-80">&bull; {readTime}</span>
      <span class="text-sm opacity-50 hidden sm:inline">&bull;</span>
      <a
        href={editUrl}
        target="_blank"
        rel="noopener noreferrer"
        class="group flex items-center gap-1 text-sm opacity-60 transition-opacity hover:opacity-100 hover:text-accent"
        title="Edit this post on GitHub"
      >
        <svg
          class="size-4 transition-transform group-hover:rotate-12"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"
          ></path>
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"
          ></path>
        </svg>
        <span class="underline decoration-dashed underline-offset-4">Edit on GitHub</span>
      </a>
    </div>

    <!-- Tags -->
    {
      tags.length > 0 && (
        <ul class="mb-4 flex flex-wrap gap-2">
          {tags.map((tag) => (
            <li class="group inline-block my-1 underline-offset-4">
              <a
                href={`/tags/${slugifyTag(tag)}/`}
                class="relative pr-2 text-sm underline decoration-dashed hover:text-accent transition-colors"
              >
                #&nbsp;{tag}
              </a>
            </li>
          ))}
        </ul>
      )
    }

    <Hr />

    <!-- Article content -->
    <article class="prose mt-6 max-w-3xl">
      <slot />
    </article>

    <Hr />

    <!-- Share links -->
    <ShareLinks title={title} url={postUrl} />

    <!-- Newsletter form -->
    <div class="mt-10">
      <NewsletterForm />
    </div>

    <!-- Prev / Next navigation -->
    <PrevNextNav prevPost={prevPost} nextPost={nextPost} />

    <Hr />

    <!-- Bottom go back link -->
    <div class="mt-6">
      <a
        href="/posts"
        class="group flex items-center gap-1 hover:text-foreground/75"
      >
        <svg
          class="inline-block size-6 transition-transform group-hover:-translate-x-1"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            d="M15 19l-7-7 7-7"></path>
        </svg>
        <span>Go back</span>
      </a>
    </div>
  </main>
</BaseLayout>
